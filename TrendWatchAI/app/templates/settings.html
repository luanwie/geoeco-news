{% extends "base.html" %}

{% block title %}Configura√ß√µes - GeoEcoNews{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 1.5rem; max-width: 800px;">
    <div class="text-center" style="margin-bottom: 3rem;">
        <h2 style="color: var(--gray-900); margin-bottom: 0.5rem;">Configura√ß√µes</h2>
        <p style="color: var(--gray-600);">Personalize seus alertas e prefer√™ncias</p>
    </div>
    
    <div class="card animate-fade-in">
        <div class="card-header" style="background: var(--purple-gradient); color: var(--white); border-radius: 16px 16px 0 0;">
            <h3 style="color: var(--white); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-cog"></i>
                Configura√ß√µes de Alertas
            </h3>
        </div>
                <div class="card-body">
                    {% if error %}
                        <div class="alert alert-danger">{{ error }}</div>
                    {% endif %}
                    
                    <form method="POST">
                        <div class="mb-3">
                            <label for="phone" class="form-label">N√∫mero do WhatsApp</label>
                            <input type="tel" class="form-control" id="phone" name="phone" 
                                   value="{{ user.phone }}" 
                                   placeholder="5551999999999"
                                   pattern="55[1-9][0-9]9[0-9]{8}"
                                   minlength="13"
                                   maxlength="13"
                                   required>
                            <div class="form-text">
                                <i class="fab fa-whatsapp" style="color: #25D366;"></i>
                                Formato: 55 + DDD + n√∫mero (sem espa√ßos ou s√≠mbolos)
                                <br><small>Exemplo: 5551999999999</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Categorias de Interesse</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="economy" 
                                       name="economy" {% if categories.economy %}checked{% endif %}>
                                <label class="form-check-label" for="economy">
                                    üìà Economia
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="geopolitics" 
                                       name="geopolitics" {% if categories.geopolitics %}checked{% endif %}>
                                <label class="form-check-label" for="geopolitics">
                                    üåç Geopol√≠tica
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="markets" 
                                       name="markets" {% if categories.markets %}checked{% endif %}>
                                <label class="form-check-label" for="markets">
                                    üí∞ Mercados
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Salvar Configura√ß√µes</button>
                        <a href="/dashboard" class="btn btn-secondary">Voltar</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function validateWhatsApp(number) {
    // Remove todos os caracteres n√£o num√©ricos
    const cleaned = number.replace(/\D/g, '');
    
    // Valida formato brasileiro: 55 + DDD + 9 + 8 d√≠gitos = 13 d√≠gitos total
    const regex = /^55[1-9][0-9]9[0-9]{8}$/;
    
    return regex.test(cleaned) ? cleaned : null;
}

function formatWhatsAppInput(input) {
    // Remove caracteres n√£o num√©ricos
    input.value = input.value.replace(/\D/g, '');
    
    // Limita a 13 d√≠gitos
    if (input.value.length > 13) {
        input.value = input.value.slice(0, 13);
    }
    
    // Valida em tempo real
    const phoneField = input;
    const isValid = validateWhatsApp(input.value);
    
    if (input.value.length >= 10) {
        if (isValid) {
            phoneField.style.borderColor = '#28a745';
            phoneField.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
        } else {
            phoneField.style.borderColor = '#dc3545';
            phoneField.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
        }
    } else {
        phoneField.style.borderColor = '';
        phoneField.style.boxShadow = '';
    }
}

// Aplicar valida√ß√£o ao campo de telefone
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('phone');
    
    phoneInput.addEventListener('input', function(e) {
        formatWhatsAppInput(e.target);
    });
    
    // Valida√ß√£o adicional no submit
    document.querySelector('form').addEventListener('submit', function(e) {
        const phoneValue = phoneInput.value;
        const validatedNumber = validateWhatsApp(phoneValue);
        
        if (!validatedNumber) {
            e.preventDefault();
            alert('Formato de WhatsApp inv√°lido. Use: 5551999999999 (55 + DDD + n√∫mero)');
            phoneInput.focus();
            return false;
        }
        
        phoneInput.value = validatedNumber;
    });
});
</script>
{% endblock %}